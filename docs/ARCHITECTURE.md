# 系统架构设计文档

> 文档版本: v1.0.0  
> 更新日期: 2024-12-29

---

## 1. 架构概述

### 1.1 设计原则

| 原则 | 说明 |
|------|------|
| **高可用** | 关键组件冗余设计，单点故障不影响核心功能 |
| **可扩展** | 模块化设计，支持功能扩展和性能扩展 |
| **安全性** | 多层安全防护，数据加密传输和存储 |
| **实时性** | 毫秒级响应，满足工业控制需求 |
| **合规性** | 满足GSP、疫苗法等合规要求 |

### 1.2 技术栈选型

```
┌─────────────────────────────────────────────────────────────────┐
│                         技术栈全景图                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │   前端层    │  │   网关层    │  │        服务层           │ │
│  │             │  │             │  │                         │ │
│  │ • React 18  │  │ • Go 1.21   │  │ • C# (.NET 4.8)        │ │
│  │ • TypeScript│  │ • Gin       │  │ • Python 3.11          │ │
│  │ • Tailwind  │  │ • gRPC      │  │ • Go 1.21              │ │
│  │ • ECharts   │  │ • WebSocket │  │                         │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │   数据层    │  │   消息层    │  │        硬件层           │ │
│  │             │  │             │  │                         │ │
│  │ • PostgreSQL│  │ • Redis     │  │ • 信捷 XC3-60          │ │
│  │ • TimescaleDB│ │ • MQTT      │  │ • 温度传感器            │ │
│  │ • Redis     │  │ • NATS      │  │ • 扫码枪               │ │
│  │             │  │             │  │ • 视觉相机             │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 硬件架构

### 2.1 硬件拓扑图

```
                                    ┌─────────────────────────┐
                                    │      云端服务器          │
                                    │  (远程监控/数据分析)     │
                                    └───────────┬─────────────┘
                                                │
                                         VPN/专线
                                                │
┌───────────────────────────────────────────────┼───────────────────────────────────────────────┐
│                                    医院内网   │                                               │
│                                               │                                               │
│   ┌─────────────┐                 ┌───────────┴───────────┐                 ┌─────────────┐  │
│   │  HIS系统    │◄───────────────►│     核心交换机        │◄───────────────►│   备份服务器 │  │
│   │  (医院)     │      HL7        │     (三层交换)        │                 │   (冷备)    │  │
│   └─────────────┘                 └───────────┬───────────┘                 └─────────────┘  │
│                                               │                                               │
│          ┌────────────────────────────────────┼────────────────────────────────────┐         │
│          │                                    │                                    │         │
│          ▼                                    ▼                                    ▼         │
│   ┌─────────────┐                    ┌─────────────┐                      ┌─────────────┐   │
│   │   工控机    │                    │   工控机    │                      │  数据库     │   │
│   │   (主)      │◄──────────────────►│   (备)      │                      │  服务器     │   │
│   │  C# + Py    │      心跳检测      │  C# + Py    │                      │ PostgreSQL  │   │
│   └──────┬──────┘                    └──────┬──────┘                      └─────────────┘   │
│          │                                   │                                               │
│          │ RS485/Modbus TCP                  │ RS485/Modbus TCP                             │
│          │                                   │                                               │
│   ┌──────┴──────┐                    ┌──────┴──────┐                                        │
│   │  信捷PLC    │                    │  信捷PLC    │                                        │
│   │  XC3-60RT  │                    │  XC3-60RT  │                                        │
│   │   (主)      │◄──────────────────►│   (备)      │                                        │
│   └──────┬──────┘    冗余切换        └─────────────┘                                        │
│          │                                                                                   │
└──────────┼───────────────────────────────────────────────────────────────────────────────────┘
           │
           │  I/O信号
           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    设备控制层                                                │
│                                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              货道矩阵 (6×10 = 60货道)                                │   │
│  │                                                                                     │   │
│  │  ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐                              │   │
│  │  │ A1 │ A2 │ A3 │ A4 │ A5 │ A6 │ A7 │ A8 │ A9 │A10 │  ← 温度传感器组1             │   │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤                              │   │
│  │  │ B1 │ B2 │ B3 │ B4 │ B5 │ B6 │ B7 │ B8 │ B9 │B10 │  ← 温度传感器组2             │   │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤                              │   │
│  │  │ C1 │ C2 │ C3 │ C4 │ C5 │ C6 │ C7 │ C8 │ C9 │C10 │  ← 温度传感器组3             │   │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤                              │   │
│  │  │ D1 │ D2 │ D3 │ D4 │ D5 │ D6 │ D7 │ D8 │ D9 │D10 │  ← 温度传感器组4             │   │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤                              │   │
│  │  │ E1 │ E2 │ E3 │ E4 │ E5 │ E6 │ E7 │ E8 │ E9 │E10 │  ← 温度传感器组5             │   │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤                              │   │
│  │  │ F1 │ F2 │ F3 │ F4 │ F5 │ F6 │ F7 │ F8 │ F9 │F10 │  ← 温度传感器组6             │   │
│  │  └────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘                              │   │
│  │                              ↓↓↓↓↓↓↓↓↓↓                                            │   │
│  │                    ████████ 主皮带传输线 ████████                                   │   │
│  │                              ↓                                                      │   │
│  │                    ┌─────────────────────┐                                          │   │
│  │                    │    视觉识别工位      │  ← 工业相机 + 扫码枪                     │   │
│  │                    └─────────────────────┘                                          │   │
│  │                              ↓                                                      │   │
│  │                    ████████ 出库皮带线 ████████                                     │   │
│  │                              ↓                                                      │   │
│  │                    ┌─────────────────────┐                                          │   │
│  │                    │      出库口         │  ← 到达传感器                             │   │
│  │                    └─────────────────────┘                                          │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 硬件清单

| 序号 | 设备名称 | 型号 | 数量 | 用途 |
|------|----------|------|------|------|
| 1 | PLC主机 | 信捷XC3-60RT | 2 | 主控制器(主/备) |
| 2 | 扩展模块 | XC-E16YR | 4 | 数字输出扩展 |
| 3 | 模拟量模块 | XC-E6AD | 2 | 温度采集 |
| 4 | 工控机 | 研华IPC-610 | 2 | 上位机(主/备) |
| 5 | 工业交换机 | 华为S5720 | 2 | 网络交换(主/备) |
| 6 | 温度传感器 | PT100 | 12 | 温度采集(每行2个) |
| 7 | 工业相机 | 海康MV-CE060 | 1 | 视觉识别 |
| 8 | 条码扫描器 | 霍尼韦尔1950g | 2 | 条码扫描(主/备) |
| 9 | 皮带电机 | 台达VFD-E | 2 | 传输驱动 |
| 10 | 货道电机 | 步进电机NEMA23 | 60 | 货道出货 |
| 11 | 光电传感器 | 欧姆龙E3Z | 62 | 位置检测 |
| 12 | UPS电源 | APC SUA3000 | 1 | 不间断电源 |

### 2.3 PLC I/O分配表

#### 输入点分配 (X)

| 地址 | 名称 | 说明 |
|------|------|------|
| X0-X9 | 货道到位A1-A10 | A行货道传感器 |
| X10-X19 | 货道到位B1-B10 | B行货道传感器 |
| X20-X29 | 货道到位C1-C10 | C行货道传感器 |
| X30-X39 | 货道到位D1-D10 | D行货道传感器 |
| X40-X49 | 货道到位E1-E10 | E行货道传感器 |
| X50-X59 | 货道到位F1-F10 | F行货道传感器 |
| X60 | 主皮带到位 | 主皮带物料检测 |
| X61 | 出库口到位 | 出库口物料检测 |
| X62 | 急停按钮 | 安全急停 |
| X63 | 门禁开关 | 柜门状态 |

#### 输出点分配 (Y)

| 地址 | 名称 | 说明 |
|------|------|------|
| Y0-Y9 | 货道电机A1-A10 | A行货道驱动 |
| Y10-Y19 | 货道电机B1-B10 | B行货道驱动 |
| Y20-Y29 | 货道电机C1-C10 | C行货道驱动 |
| Y30-Y39 | 货道电机D1-D10 | D行货道驱动 |
| Y40-Y49 | 货道电机E1-E10 | E行货道驱动 |
| Y50-Y59 | 货道电机F1-F10 | F行货道驱动 |
| Y60 | 主皮带正转 | 主皮带正向运行 |
| Y61 | 主皮带反转 | 主皮带反向运行 |
| Y62 | 报警灯 | 声光报警 |
| Y63 | 蜂鸣器 | 声音报警 |

#### 模拟量分配 (AD)

| 地址 | 名称 | 范围 | 说明 |
|------|------|------|------|
| AD0-AD1 | 温度组A | 2-8℃ | A行温度采集 |
| AD2-AD3 | 温度组B | 2-8℃ | B行温度采集 |
| AD4-AD5 | 温度组C | 2-8℃ | C行温度采集 |
| AD6-AD7 | 温度组D | 2-8℃ | D行温度采集 |
| AD8-AD9 | 温度组E | 2-8℃ | E行温度采集 |
| AD10-AD11 | 温度组F | 2-8℃ | F行温度采集 |

---

## 3. 软件架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    系统软件架构图                                            │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              展示层 (Presentation Layer)                             │   │
│  │  ┌─────────────────────┐  ┌──────────────────────────────────────────────────────┐  │   │
│  │  │  WinForms 控制台    │  │              React Web 监控端                         │  │   │
│  │  │  (本地操作)         │  │              (远程监控)                               │  │   │
│  │  │  • 设备状态监控      │  │  • 仪表盘      • 任务管理      • 库存管理            │  │   │
│  │  │  • 任务执行控制      │  │  • 温度监控    • 追溯查询      • 报表统计            │  │   │
│  │  │  • 报警处理         │  │  • 报警中心    • 系统设置                            │  │   │
│  │  └─────────────────────┘  └──────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                                 │
│                                    WebSocket / REST                                         │
│                                           │                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              网关层 (Gateway Layer)                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │                          Go API Gateway                                          │ │   │
│  │  │  • 认证授权 (JWT)     • 请求路由      • 限流熔断      • 日志审计               │ │   │
│  │  │  • 协议转换           • 负载均衡      • API版本管理   • 健康检查               │ │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                                 │
│                               gRPC / HTTP / Message Queue                                   │
│                                           │                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              服务层 (Service Layer)                                  │   │
│  │                                                                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │   │
│  │  │  C# 主控服务  │  │ Python AI   │  │  Go 业务    │  │  Go 对接    │            │   │
│  │  │              │  │    服务      │  │    服务      │  │    服务      │            │   │
│  │  │ • PLC通信    │  │ • 视觉识别  │  │ • 库存管理  │  │ • HIS对接   │            │   │
│  │  │ • 设备控制   │  │ • 条码解析  │  │ • 订单处理  │  │ • 追溯上报  │            │   │
│  │  │ • 状态采集   │  │ • 温度预测  │  │ • 任务调度  │  │ • 数据同步  │            │   │
│  │  │ • 本地缓存   │  │ • 数据分析  │  │ • 预警处理  │  │             │            │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              数据层 (Data Layer)                                     │   │
│  │                                                                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │   │
│  │  │  PostgreSQL  │  │ TimescaleDB  │  │    Redis     │  │    MinIO     │            │   │
│  │  │              │  │              │  │              │  │              │            │   │
│  │  │ • 业务数据   │  │ • 温度时序  │  │ • 会话缓存  │  │ • 图片存储  │            │   │
│  │  │ • 追溯记录   │  │ • 运行日志  │  │ • 实时状态  │  │ • 日志归档  │            │   │
│  │  │ • 用户权限   │  │ • 统计聚合  │  │ • 消息队列  │  │             │            │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 服务划分

#### 3.2.1 C# 主控服务 (VaccineControlSystem)

**职责**: 本地设备控制和实时数据采集

```
VaccineControlSystem/
├── Core/                          # 核心模块
│   ├── PlcCommunication/          # PLC通信
│   │   ├── ModbusTcpClient.cs     # Modbus TCP客户端
│   │   ├── PlcDataReader.cs       # 数据读取
│   │   └── PlcCommandWriter.cs    # 指令写入
│   ├── DeviceControl/             # 设备控制
│   │   ├── ChannelController.cs   # 货道控制
│   │   ├── ConveyorController.cs  # 皮带控制
│   │   └── AlarmController.cs     # 报警控制
│   └── DataCollection/            # 数据采集
│       ├── TemperatureCollector.cs # 温度采集
│       └── SensorCollector.cs     # 传感器采集
├── Services/                      # 服务层
│   ├── SortingService.cs          # 分拣服务
│   ├── InventoryService.cs        # 库存服务
│   └── AlarmService.cs            # 报警服务
├── UI/                            # 界面层
│   ├── MainForm.cs                # 主窗体
│   ├── ChannelMatrixControl.cs    # 货道矩阵控件
│   └── StatusPanel.cs             # 状态面板
└── Common/                        # 公共模块
    ├── Config/                    # 配置管理
    ├── Logging/                   # 日志记录
    └── Utils/                     # 工具类
```

#### 3.2.2 Python AI 服务 (vaccine-vision)

**职责**: 视觉识别和智能分析

```
python-vision/
├── vision/                        # 视觉识别
│   ├── camera.py                  # 相机控制
│   ├── detector.py                # 物体检测
│   ├── ocr.py                     # 文字识别
│   └── barcode.py                 # 条码解析
├── analytics/                     # 数据分析
│   ├── temperature_predictor.py   # 温度预测
│   ├── inventory_optimizer.py     # 库存优化
│   └── anomaly_detector.py        # 异常检测
├── api/                           # API接口
│   ├── grpc_server.py             # gRPC服务
│   └── rest_api.py                # REST接口
└── models/                        # AI模型
    ├── yolo_vaccine.pt            # 疫苗检测模型
    └── ocr_model.pt               # OCR模型
```

#### 3.2.3 Go 网关服务 (go-gateway)

**职责**: API网关和业务编排

```
go-gateway/
├── cmd/
│   └── server/
│       └── main.go                # 入口
├── internal/
│   ├── handler/                   # 请求处理
│   │   ├── auth.go                # 认证
│   │   ├── vaccine.go             # 疫苗API
│   │   ├── inventory.go           # 库存API
│   │   └── monitor.go             # 监控API
│   ├── service/                   # 业务逻辑
│   │   ├── sorting.go             # 分拣服务
│   │   ├── tracing.go             # 追溯服务
│   │   └── alert.go               # 报警服务
│   ├── repository/                # 数据访问
│   │   ├── vaccine_repo.go
│   │   └── inventory_repo.go
│   ├── middleware/                # 中间件
│   │   ├── auth.go                # 认证中间件
│   │   ├── ratelimit.go           # 限流
│   │   └── logging.go             # 日志
│   └── pkg/                       # 公共包
│       ├── config/
│       ├── database/
│       └── redis/
├── api/
│   └── proto/                     # gRPC定义
└── configs/
    └── config.yaml
```

### 3.3 通信架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    通信架构图                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌───────────────┐                                              ┌───────────────┐          │
│  │   Web前端     │ ◄──────── WebSocket ─────────────────────────►│  Go Gateway  │          │
│  │   (React)     │ ◄──────── REST API ──────────────────────────►│              │          │
│  └───────────────┘                                              └───────┬───────┘          │
│                                                                         │                   │
│                                                           ┌─────────────┼─────────────┐    │
│                                                           │             │             │    │
│                                                    gRPC   │      gRPC   │      HTTP   │    │
│                                                           │             │             │    │
│                                                           ▼             ▼             ▼    │
│  ┌───────────────┐    Modbus TCP    ┌───────────────┐   ┌─────┐   ┌─────┐   ┌───────────┐ │
│  │   信捷PLC     │ ◄───────────────►│  C# 主控      │◄─►│Redis│◄─►│ Go  │◄─►│  Python   │ │
│  │               │                  │               │   │     │   │业务 │   │  Vision   │ │
│  └───────────────┘                  └───────┬───────┘   └──┬──┘   └──┬──┘   └───────────┘ │
│                                             │              │         │                     │
│                                             │              │   PostgreSQL                  │
│                                             │              │         │                     │
│                                             ▼              ▼         ▼                     │
│                                      ┌─────────────────────────────────────┐              │
│                                      │           数据库集群                 │              │
│                                      │  PostgreSQL + TimescaleDB + Redis   │              │
│                                      └─────────────────────────────────────┘              │
│                                                                                             │
│  ┌───────────────┐        HL7 FHIR / REST API        ┌───────────────┐                    │
│  │   HIS系统     │ ◄────────────────────────────────►│  Go Gateway   │                    │
│  │   (医院)      │                                   │  (HIS对接)    │                    │
│  └───────────────┘                                   └───────────────┘                    │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 数据流设计

#### 3.4.1 分拣任务数据流

```
┌────────────────────────────────────────────────────────────────────────────────────────────┐
│                              分拣任务数据流                                                 │
├────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                            │
│   ① HIS下发订单                                                                           │
│   ┌─────────┐    HL7      ┌─────────┐                                                     │
│   │   HIS   │ ──────────► │Go Gateway│                                                     │
│   └─────────┘             └────┬────┘                                                     │
│                                │                                                           │
│   ② 订单解析入库               │ REST                                                     │
│                                ▼                                                           │
│                          ┌─────────┐    INSERT     ┌─────────┐                            │
│                          │Go 业务  │ ────────────► │PostgreSQL│                            │
│                          └────┬────┘               └─────────┘                            │
│                                │                                                           │
│   ③ 推送到本地控制            │ Redis Pub/Sub                                             │
│                                ▼                                                           │
│                          ┌─────────┐                                                       │
│                          │  Redis  │                                                       │
│                          └────┬────┘                                                       │
│                                │                                                           │
│   ④ 主控接收任务              │ Subscribe                                                 │
│                                ▼                                                           │
│                          ┌─────────┐                                                       │
│                          │C# 主控  │                                                       │
│                          └────┬────┘                                                       │
│                                │                                                           │
│   ⑤ 发送PLC指令               │ Modbus TCP                                                │
│                                ▼                                                           │
│                          ┌─────────┐    I/O信号    ┌─────────┐                            │
│                          │信捷 PLC │ ────────────► │ 货道电机 │                            │
│                          └────┬────┘               └─────────┘                            │
│                                │                                                           │
│   ⑥ 视觉复核                  │ 触发                                                      │
│                                ▼                                                           │
│                          ┌─────────┐    gRPC       ┌─────────┐                            │
│                          │工业相机 │ ────────────► │Py Vision│                            │
│                          └─────────┘               └────┬────┘                            │
│                                                         │                                  │
│   ⑦ 更新状态                                           │ gRPC                            │
│                                                         ▼                                  │
│                          ┌─────────┐    UPDATE     ┌─────────┐    WebSocket  ┌─────────┐ │
│                          │PostgreSQL│ ◄──────────── │Go 业务  │ ────────────► │ Web前端 │ │
│                          └─────────┘               └─────────┘               └─────────┘ │
│                                                                                            │
└────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 冗余设计

### 4.1 冗余架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    冗余设计架构                                              │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              网络冗余层                                                │ │
│  │                                                                                        │ │
│  │      ┌─────────────┐              双链路               ┌─────────────┐                │ │
│  │      │  交换机 A   │ ◄─────────────────────────────►  │  交换机 B   │                │ │
│  │      │   (主)      │                                   │   (备)      │                │ │
│  │      └──────┬──────┘                                   └──────┬──────┘                │ │
│  │             │                                                  │                       │ │
│  └─────────────┼──────────────────────────────────────────────────┼───────────────────────┘ │
│                │                                                  │                         │
│  ┌─────────────┼──────────────────────────────────────────────────┼───────────────────────┐ │
│  │             ▼           计算冗余层                             ▼                       │ │
│  │      ┌─────────────┐                                   ┌─────────────┐                │ │
│  │      │  工控机 A   │◄─────── 心跳检测/状态同步 ────────►│  工控机 B   │                │ │
│  │      │   (主)      │         (UDP 组播)                │   (热备)    │                │ │
│  │      └──────┬──────┘                                   └──────┬──────┘                │ │
│  │             │                                                  │                       │ │
│  └─────────────┼──────────────────────────────────────────────────┼───────────────────────┘ │
│                │                                                  │                         │
│  ┌─────────────┼──────────────────────────────────────────────────┼───────────────────────┐ │
│  │             ▼           控制冗余层                             ▼                       │ │
│  │      ┌─────────────┐                                   ┌─────────────┐                │ │
│  │      │   PLC A     │◄─────── 双机热备 ─────────────────►│   PLC B     │                │ │
│  │      │   (主)      │       (信捷热备功能)              │   (备)      │                │ │
│  │      └──────┬──────┘                                   └─────────────┘                │ │
│  │             │                                                                          │ │
│  │             ▼                                                                          │ │
│  │      ┌─────────────────────────────────────────────────────────────────────────────┐  │ │
│  │      │                            执行层 (无冗余)                                   │  │ │
│  │      │                     货道电机 / 皮带线 / 传感器                               │  │ │
│  │      └─────────────────────────────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              数据冗余层                                                │ │
│  │                                                                                        │ │
│  │      ┌─────────────┐        主从复制         ┌─────────────┐                          │ │
│  │      │ PostgreSQL  │ ◄─────────────────────► │ PostgreSQL  │                          │ │
│  │      │   (主)      │      流复制             │   (从)      │                          │ │
│  │      └─────────────┘                         └─────────────┘                          │ │
│  │                                                                                        │ │
│  │      ┌─────────────┐        Sentinel         ┌─────────────┐                          │ │
│  │      │   Redis     │ ◄─────────────────────► │   Redis     │                          │ │
│  │      │   (主)      │       主从哨兵          │   (从)      │                          │ │
│  │      └─────────────┘                         └─────────────┘                          │ │
│  │                                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 故障切换策略

| 故障类型 | 检测方式 | 切换时间 | 切换策略 |
|----------|----------|----------|----------|
| 工控机故障 | 心跳超时(3s) | <5s | 备机自动接管 |
| PLC故障 | 通信超时(1s) | <2s | 备PLC激活 |
| 网络故障 | 链路检测 | <3s | 切换备用链路 |
| 数据库故障 | 连接检测 | <10s | 从库提升为主 |
| Redis故障 | Sentinel检测 | <5s | 哨兵自动切换 |

---

## 5. 安全架构

### 5.1 安全分层

```
┌─────────────────────────────────────────────────────────────────┐
│                        安全架构分层                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    应用安全层                              │ │
│  │  • JWT Token认证      • RBAC权限控制    • 操作审计日志    │ │
│  │  • 输入验证过滤       • SQL注入防护     • XSS防护        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    传输安全层                              │ │
│  │  • TLS 1.3加密        • 证书双向认证    • API签名验证     │ │
│  │  • WebSocket WSS      • gRPC TLS       • VPN隧道         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    数据安全层                              │ │
│  │  • AES-256存储加密    • 敏感字段脱敏    • 数据备份加密    │ │
│  │  • 数据库访问控制     • 审计日志        • 数据生命周期    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    网络安全层                              │ │
│  │  • 防火墙隔离         • VLAN划分        • 入侵检测        │ │
│  │  • DDoS防护          • IP白名单        • 端口限制        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    物理安全层                              │ │
│  │  • 机房门禁           • 设备柜门锁      • 监控摄像        │ │
│  │  • UPS电源           • 温湿度监控      • 消防系统        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 认证授权流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户    │     │  网关    │     │ 认证服务  │     │ 业务服务  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1.登录请求     │                │                │
     │───────────────►│                │                │
     │                │ 2.验证凭证     │                │
     │                │───────────────►│                │
     │                │                │                │
     │                │ 3.返回JWT Token│                │
     │                │◄───────────────│                │
     │ 4.返回Token    │                │                │
     │◄───────────────│                │                │
     │                │                │                │
     │ 5.携带Token请求│                │                │
     │───────────────►│                │                │
     │                │ 6.验证Token    │                │
     │                │───────────────►│                │
     │                │ 7.Token有效    │                │
     │                │◄───────────────│                │
     │                │ 8.转发请求(含用户信息)          │
     │                │────────────────────────────────►│
     │                │                │                │
     │                │ 9.业务响应     │                │
     │◄─────────────────────────────────────────────────│
     │                │                │                │
```

---

## 6. 部署架构

### 6.1 部署拓扑

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    部署架构图                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              云端部署 (可选)                                           │ │
│  │                                                                                        │ │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │ │
│  │   │   Nginx     │    │  Go Gateway │    │  PostgreSQL │    │   Grafana   │           │ │
│  │   │  (负载均衡) │    │   (容器)    │    │   (RDS)     │    │   (监控)    │           │ │
│  │   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘           │ │
│  │                                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                                  │
│                                    VPN / 专线                                               │
│                                          │                                                  │
│  ┌───────────────────────────────────────┼───────────────────────────────────────────────┐ │
│  │                              本地部署 │                                                │ │
│  │                                       │                                                │ │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────┐ │ │
│  │   │                           工控机 A (主)                                          │ │ │
│  │   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │ │ │
│  │   │   │ C# 主控  │  │ Python   │  │ Go本地   │  │PostgreSQL│  │  Redis   │        │ │ │
│  │   │   │ WinForms │  │ Vision   │  │ Gateway  │  │ (本地)   │  │ (本地)   │        │ │ │
│  │   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │ │ │
│  │   └─────────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                                        │ │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────┐ │ │
│  │   │                           工控机 B (备)                                          │ │ │
│  │   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │ │ │
│  │   │   │ C# 主控  │  │ Python   │  │ Go本地   │  │PostgreSQL│  │  Redis   │        │ │ │
│  │   │   │ (热备)   │  │ (热备)   │  │ (热备)   │  │ (从库)   │  │ (从库)   │        │ │ │
│  │   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │ │ │
│  │   └─────────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 服务端口规划

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| C# 主控 | 5000 | gRPC | 本地控制服务 |
| Python Vision | 5001 | gRPC | 视觉识别服务 |
| Go Gateway | 8080 | HTTP | REST API |
| Go Gateway | 8081 | WebSocket | 实时推送 |
| Go Gateway | 9090 | gRPC | 内部通信 |
| PostgreSQL | 5432 | TCP | 数据库 |
| Redis | 6379 | TCP | 缓存 |
| PLC Modbus | 502 | TCP | PLC通信 |

---

## 7. 技术选型说明

### 7.1 为什么选择混合技术栈

| 语言 | 选用原因 | 适用场景 |
|------|----------|----------|
| **C#** | 与Windows/PLC集成好，UI开发成熟 | 本地主控、设备通信 |
| **Python** | AI/CV生态丰富，开发效率高 | 视觉识别、数据分析 |
| **Go** | 高并发、低延迟，部署简单 | API网关、业务服务 |
| **TypeScript** | 类型安全，前端工程化成熟 | Web远程监控 |

### 7.2 关键技术选型

| 技术领域 | 选型 | 备选方案 | 选择理由 |
|----------|------|----------|----------|
| PLC通信 | Modbus TCP | OPC UA | 信捷PLC原生支持，简单可靠 |
| 消息队列 | Redis Pub/Sub | RabbitMQ | 轻量级，满足当前规模 |
| 时序数据库 | TimescaleDB | InfluxDB | 基于PostgreSQL，学习成本低 |
| 视觉框架 | OpenCV + YOLO | Halcon | 开源免费，社区活跃 |
| Web框架 | React + Vite | Vue3 | 生态成熟，组件丰富 |
| API框架 | Gin | Echo | 性能优异，文档完善 |

---

> 文档审批：
> - 架构师: __________ 日期: __________
> - 技术负责人: __________ 日期: __________

